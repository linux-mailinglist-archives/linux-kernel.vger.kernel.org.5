Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id BE3567B2836
	for <lists+linux-kernel@lfdr.de>; Fri, 29 Sep 2023 00:13:57 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232593AbjI1WN4 (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Thu, 28 Sep 2023 18:13:56 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:33722 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230325AbjI1WNv (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 28 Sep 2023 18:13:51 -0400
Received: from mout.gmx.net (mout.gmx.net [212.227.15.15])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id A524019D;
        Thu, 28 Sep 2023 15:13:48 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=gmx.de; s=s31663417;
 t=1695939213; x=1696544013; i=linosanfilippo@gmx.de;
 bh=nLuCqydJpbT7/9fmhJ6R8xv1g0Gm3uYcudny9uknJvc=;
 h=X-UI-Sender-Class:From:To:Cc:Subject:Date:In-Reply-To:References;
 b=iMdIbDs6hkKyO856ypck2MXVe5QSCjVfBVZtwzeeo3qsdnLk0KaFYCX6cCcPWZc7C4B/TpruqPt
 4A6ra1eTSbEIOEQRdZSWh5jd6V2/cEw7i2LsOKCjGvKgpeBUfF0lsdPRy/9xTpnqtNX+oWaP9L7DD
 qErLrh4tCmfG9Vm2h09MiDoVskACydDsxPo234Iycl6FMIGvCsXL7Bpl9Ey1lrzG/1j7xZcCQWGg4
 YyfN0eLKCwRCNwAwwvGObHYQMQF17SHRLLW+Wh2MLryoF/OdWsSXTo+waRfPD7vgv84nxrY668Hpq
 RICKPpXJMrVm+OX3r8LU1mVsbx/d3RFRybKA==
X-UI-Sender-Class: 724b4f7f-cbec-4199-ad4e-598c01a50d3a
Received: from Venus.speedport.ip ([84.162.21.41]) by mail.gmx.net (mrgmx005
 [212.227.17.190]) with ESMTPSA (Nemesis) id 1MTRR0-1rDNVw3oyq-00TnOw; Fri, 29
 Sep 2023 00:13:32 +0200
From:   Lino Sanfilippo <LinoSanfilippo@gmx.de>
To:     gregkh@linuxfoundation.org, jirislaby@kernel.org
Cc:     shawnguo@kernel.org, s.hauer@pengutronix.de,
        ilpo.jarvinen@linux.intel.com, mcoquelin.stm32@gmail.com,
        alexandre.torgue@foss.st.com, linux-kernel@vger.kernel.org,
        linux-serial@vger.kernel.org, l.sanfilippo@kunbus.com,
        LinoSanfilippo@gmx.de, lukas@wunner.de, p.rosenberger@kunbus.com,
        stable@vger.kernel.org
Subject: [PATCH 1/6] serial: Do not hold the port lock when setting rx-during-tx GPIO
Date:   Fri, 29 Sep 2023 00:12:41 +0200
Message-Id: <20230928221246.13689-2-LinoSanfilippo@gmx.de>
X-Mailer: git-send-email 2.40.1
In-Reply-To: <20230928221246.13689-1-LinoSanfilippo@gmx.de>
References: <20230928221246.13689-1-LinoSanfilippo@gmx.de>
MIME-Version: 1.0
Content-Transfer-Encoding: base64
X-Provags-ID: V03:K1:3LQwxQSDEDvmzvUu0aiddYpQ6pCaYOyJGCzvgx6N1RGoFucwpwd
 3OBRNEhvnDQUFl3ZSJeLSpSHx6WPuD4ZC+TGJCE3NVcaVAAT7VizG1Qgpy7gFmsXUDF/8lo
 cAXHjM5NSa2V5YALy7fTQK4Yp67C3csXzbv8L3KHUNMikH1jm7yJJBgbKtBZEoGFjT/iON8
 BhjCpmToMVvydbOSb3wXg==
UI-OutboundReport: notjunk:1;M01:P0:4UOvIHl79A4=;Eoatoxh+nvzVe0uNQsm1zZ1tOjV
 4aQyuaiODTgaMd68fC0bW3uCoO7z5ot+NwiDsqIgX12Rg8ucC/zS6K3V309p+3fF+Bw1Uk7KI
 drox1azOMHM/vq7Ubn6wAqVjQ97DQtUXw5QRLfIS+RytZ7IfO0wkSb9fk+8XIMT8yEykUCk9D
 X78uwN21LKE3lqPUWzvBbP6datfMNPfgX6bVNFdWEcmzj6Cnl9dno3LSzJ874btGg8/zumhUp
 pn8lP+9lt9AaEzjasDwSn9dTbBF2q4GbAjGYkC90sl0kDjU5zlhCIE5YIx1ZjYnHqrqUyBJsP
 wRtX56Tnwu2rpIJMBTOySi3UlWo7LD0gQKCumNO8NumryDvK0hY2Ib7mnYjUK9BGEZvtwluY6
 dkOUmqxyss5mOLh0lC2y1mSN/AjCLK+MFPzJ1AS4+3V8KbZW+uqFJ5AzCAP4EJGlaQhvdbMp3
 2LG7QGcjWJFU/VA/b8m4/G1RxZ1Slhg2m5J7+LzpsDUzG5ebHRsy/R7MGcFRZ/s90XZflM1H7
 azTLULNgU+DrswSTBs7ffDSsOWS4EGyURcPntyo0W3/WTbXfiIOi8Hq4D5e12UYwdk5aAHE9a
 VjDCPD42LzXROlcoeTpQnX9vokKmRdpiTbR6QKndUrVR1qxmRve+4nTOT7W6Ewx4xLPVRfuZM
 uMrmAeAx9WtKVnSO7xp3r1kuz5gC/X+nWGvqNS+3YyfVaV1aPBs6fA/iMZmndJS7HHOr4EB06
 3GpA07E7aEUuTln7YYwRzHnaA5WOzf7EGvJ524JIDQxuxOjg7DRRvfeq5Zf86+wNoXxFADGTQ
 /mq4bAG0imdfTsHCIyPeS69V0IIg0PD5rfY3yV6LjaDKJUgtIPWtUfvdGJQnLv2X3D52so/Xk
 SIc/ceRfVJKmxCqY22B6tzdmFI16wsZHLVYQR8Q6IFZqB4ja7uf0dYWyzAeprKk2f9NrsOjck
 8SB5Qqpd4WoU4zNLwyBV/4eHrrU=
X-Spam-Status: No, score=-0.4 required=5.0 tests=BAYES_00,DKIM_SIGNED,
        DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,FREEMAIL_FROM,MIME_BASE64_TEXT,
        RCVD_IN_DNSWL_BLOCKED,RCVD_IN_MSPIKE_H4,RCVD_IN_MSPIKE_WL,
        SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

RnJvbTogTGlubyBTYW5maWxpcHBvIDxsLnNhbmZpbGlwcG9Aa3VuYnVzLmNvbT4KCkJvdGggdGhl
IGlteCBhbmQgc3RtMzIgZHJpdmVyIHNldCB0aGUgcngtZHVyaW5nLXR4IEdQSU8gaW4gdGhlCnJz
NDg1X2NvbmZpZygpIGZ1bmN0aW9uIGJ5IG1lYW5zIG9mIGdwaW9kX3NldF92YWx1ZSgpLiBTaW5j
ZSByczQ4NV9jb25maWcoKQppcyBjYWxsZWQgd2l0aCB0aGUgcG9ydCBsb2NrIGhlbGQsIHRoaXMg
Y2FuIGJlIGFuIHByb2JsZW0gaW4gY2FzZSB0aGF0CnNldHRpbmcgdGhlIEdQSU8gbGluZSBjYW4g
c2xlZXAgKGUuZy4gaWYgYSBHUElPIGV4cGFuZGVyIGlzIHVzZWQgd2hpY2ggaXMKY29ubmVjdGVk
IHZpYSBTUEkgb3IgSTJDKS4KCkF2b2lkIHRoaXMgaXNzdWUgYnkgc2V0dGluZyB0aGUgR1BJTyBv
dXRzaWRlIG9mIHRoZSBwb3J0IGxvY2sgaW4gdGhlIHNlcmlhbApjb3JlIGFuZCBieSB1c2luZyBn
cGlvZF9zZXRfdmFsdWVfY2Fuc2xlZXAoKSBpbnN0ZWFkIG9mIGdwaW9kX3NldF92YWx1ZSgpLgoK
U2luY2Ugbm93IGJvdGggdGhlIHRlcm0gYW5kIHRoZSByeC1kdXJpbmctdHggR1BJTyBhcmUgc2V0
IHdpdGhpbiB0aGUgc2VyaWFsCmNvcmUgdXNlIGEgY29tbW9uIGZ1bmN0aW9uIHVhcnRfc2V0X3Jz
NDg1X2dwaW9zKCkgdG8gc2V0IGJvdGguCgpXaXRoIG1vdmluZyBpdCBpbnRvIHRoZSBzZXJpYWwg
Y29yZSBzZXR0aW5nIHRoZSByeC1kdXJpbmctdHggR1BJTyBpcyBub3cKYXV0b21hdGljYWxseSBk
b25lIGZvciBhbGwgZHJpdmVycyB0aGF0IHN1cHBvcnQgc3VjaCBhIEdQSU8uCgpDYzogc3RhYmxl
QHZnZXIua2VybmVsLm9yZwpTaWduZWQtb2ZmLWJ5OiBMaW5vIFNhbmZpbGlwcG8gPGwuc2FuZmls
aXBwb0BrdW5idXMuY29tPgotLS0KIGRyaXZlcnMvdHR5L3NlcmlhbC9pbXguYyAgICAgICAgIHwg
IDQgLS0tLQogZHJpdmVycy90dHkvc2VyaWFsL3NlcmlhbF9jb3JlLmMgfCAxMCArKysrKystLS0t
CiBkcml2ZXJzL3R0eS9zZXJpYWwvc3RtMzItdXNhcnQuYyB8ICA1ICstLS0tCiAzIGZpbGVzIGNo
YW5nZWQsIDcgaW5zZXJ0aW9ucygrKSwgMTIgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJp
dmVycy90dHkvc2VyaWFsL2lteC5jIGIvZHJpdmVycy90dHkvc2VyaWFsL2lteC5jCmluZGV4IDEz
Y2I3ODM0MDcwOS4uZWRiMmVjNmE1NTY3IDEwMDY0NAotLS0gYS9kcml2ZXJzL3R0eS9zZXJpYWwv
aW14LmMKKysrIGIvZHJpdmVycy90dHkvc2VyaWFsL2lteC5jCkBAIC0xOTQ3LDEwICsxOTQ3LDYg
QEAgc3RhdGljIGludCBpbXhfdWFydF9yczQ4NV9jb25maWcoc3RydWN0IHVhcnRfcG9ydCAqcG9y
dCwgc3RydWN0IGt0ZXJtaW9zICp0ZXJtaW8KIAkgICAgcnM0ODVjb25mLT5mbGFncyAmIFNFUl9S
UzQ4NV9SWF9EVVJJTkdfVFgpCiAJCWlteF91YXJ0X3N0YXJ0X3J4KHBvcnQpOwogCi0JaWYgKHBv
cnQtPnJzNDg1X3J4X2R1cmluZ190eF9ncGlvKQotCQlncGlvZF9zZXRfdmFsdWVfY2Fuc2xlZXAo
cG9ydC0+cnM0ODVfcnhfZHVyaW5nX3R4X2dwaW8sCi0JCQkJCSAhIShyczQ4NWNvbmYtPmZsYWdz
ICYgU0VSX1JTNDg1X1JYX0RVUklOR19UWCkpOwotCiAJcmV0dXJuIDA7CiB9CiAKZGlmZiAtLWdp
dCBhL2RyaXZlcnMvdHR5L3NlcmlhbC9zZXJpYWxfY29yZS5jIGIvZHJpdmVycy90dHkvc2VyaWFs
L3NlcmlhbF9jb3JlLmMKaW5kZXggN2JkYzIxZDVlMTNiLi5lZjA1MDBiZTM1NTMgMTAwNjQ0Ci0t
LSBhL2RyaXZlcnMvdHR5L3NlcmlhbC9zZXJpYWxfY29yZS5jCisrKyBiL2RyaXZlcnMvdHR5L3Nl
cmlhbC9zZXJpYWxfY29yZS5jCkBAIC0xMzkxLDE0ICsxMzkxLDE2IEBAIHN0YXRpYyB2b2lkIHVh
cnRfc2FuaXRpemVfc2VyaWFsX3JzNDg1KHN0cnVjdCB1YXJ0X3BvcnQgKnBvcnQsIHN0cnVjdCBz
ZXJpYWxfcnM0CiAJbWVtc2V0KHJzNDg1LT5wYWRkaW5nMSwgMCwgc2l6ZW9mKHJzNDg1LT5wYWRk
aW5nMSkpOwogfQogCi1zdGF0aWMgdm9pZCB1YXJ0X3NldF9yczQ4NV90ZXJtaW5hdGlvbihzdHJ1
Y3QgdWFydF9wb3J0ICpwb3J0LAotCQkJCSAgICAgICBjb25zdCBzdHJ1Y3Qgc2VyaWFsX3JzNDg1
ICpyczQ4NSkKK3N0YXRpYyB2b2lkIHVhcnRfc2V0X3JzNDg1X2dwaW9zKHN0cnVjdCB1YXJ0X3Bv
cnQgKnBvcnQsCisJCQkJIGNvbnN0IHN0cnVjdCBzZXJpYWxfcnM0ODUgKnJzNDg1KQogewogCWlm
ICghKHJzNDg1LT5mbGFncyAmIFNFUl9SUzQ4NV9FTkFCTEVEKSkKIAkJcmV0dXJuOwogCiAJZ3Bp
b2Rfc2V0X3ZhbHVlX2NhbnNsZWVwKHBvcnQtPnJzNDg1X3Rlcm1fZ3BpbywKIAkJCQkgISEocnM0
ODUtPmZsYWdzICYgU0VSX1JTNDg1X1RFUk1JTkFURV9CVVMpKTsKKwlncGlvZF9zZXRfdmFsdWVf
Y2Fuc2xlZXAocG9ydC0+cnM0ODVfcnhfZHVyaW5nX3R4X2dwaW8sCisJCQkJICEhKHJzNDg1LT5m
bGFncyAmIFNFUl9SUzQ4NV9SWF9EVVJJTkdfVFgpKTsKIH0KIAogc3RhdGljIGludCB1YXJ0X3Jz
NDg1X2NvbmZpZyhzdHJ1Y3QgdWFydF9wb3J0ICpwb3J0KQpAQCAtMTQwNyw3ICsxNDA5LDcgQEAg
c3RhdGljIGludCB1YXJ0X3JzNDg1X2NvbmZpZyhzdHJ1Y3QgdWFydF9wb3J0ICpwb3J0KQogCWlu
dCByZXQ7CiAKIAl1YXJ0X3Nhbml0aXplX3NlcmlhbF9yczQ4NShwb3J0LCByczQ4NSk7Ci0JdWFy
dF9zZXRfcnM0ODVfdGVybWluYXRpb24ocG9ydCwgcnM0ODUpOworCXVhcnRfc2V0X3JzNDg1X2dw
aW9zKHBvcnQsIHJzNDg1KTsKIAogCXJldCA9IHBvcnQtPnJzNDg1X2NvbmZpZyhwb3J0LCBOVUxM
LCByczQ4NSk7CiAJaWYgKHJldCkKQEAgLTE0NDksNyArMTQ1MSw3IEBAIHN0YXRpYyBpbnQgdWFy
dF9zZXRfcnM0ODVfY29uZmlnKHN0cnVjdCB0dHlfc3RydWN0ICp0dHksIHN0cnVjdCB1YXJ0X3Bv
cnQgKnBvcnQsCiAJaWYgKHJldCkKIAkJcmV0dXJuIHJldDsKIAl1YXJ0X3Nhbml0aXplX3Nlcmlh
bF9yczQ4NShwb3J0LCAmcnM0ODUpOwotCXVhcnRfc2V0X3JzNDg1X3Rlcm1pbmF0aW9uKHBvcnQs
ICZyczQ4NSk7CisJdWFydF9zZXRfcnM0ODVfZ3Bpb3MocG9ydCwgJnJzNDg1KTsKIAogCXNwaW5f
bG9ja19pcnFzYXZlKCZwb3J0LT5sb2NrLCBmbGFncyk7CiAJcmV0ID0gcG9ydC0+cnM0ODVfY29u
ZmlnKHBvcnQsICZ0dHktPnRlcm1pb3MsICZyczQ4NSk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL3R0
eS9zZXJpYWwvc3RtMzItdXNhcnQuYyBiL2RyaXZlcnMvdHR5L3NlcmlhbC9zdG0zMi11c2FydC5j
CmluZGV4IDVlOWNmMGM0ODgxMy4uOGViMTNiZjA1NWYyIDEwMDY0NAotLS0gYS9kcml2ZXJzL3R0
eS9zZXJpYWwvc3RtMzItdXNhcnQuYworKysgYi9kcml2ZXJzL3R0eS9zZXJpYWwvc3RtMzItdXNh
cnQuYwpAQCAtMjI2LDEwICsyMjYsNyBAQCBzdGF0aWMgaW50IHN0bTMyX3VzYXJ0X2NvbmZpZ19y
czQ4NShzdHJ1Y3QgdWFydF9wb3J0ICpwb3J0LCBzdHJ1Y3Qga3Rlcm1pb3MgKnRlcgogCiAJc3Rt
MzJfdXNhcnRfY2xyX2JpdHMocG9ydCwgb2ZzLT5jcjEsIEJJVChjZmctPnVhcnRfZW5hYmxlX2Jp
dCkpOwogCi0JaWYgKHBvcnQtPnJzNDg1X3J4X2R1cmluZ190eF9ncGlvKQotCQlncGlvZF9zZXRf
dmFsdWVfY2Fuc2xlZXAocG9ydC0+cnM0ODVfcnhfZHVyaW5nX3R4X2dwaW8sCi0JCQkJCSAhIShy
czQ4NWNvbmYtPmZsYWdzICYgU0VSX1JTNDg1X1JYX0RVUklOR19UWCkpOwotCWVsc2UKKwlpZiAo
IXBvcnQtPnJzNDg1X3J4X2R1cmluZ190eF9ncGlvKQogCQlyczQ4NWNvbmYtPmZsYWdzIHw9IFNF
Ul9SUzQ4NV9SWF9EVVJJTkdfVFg7CiAKIAlpZiAocnM0ODVjb25mLT5mbGFncyAmIFNFUl9SUzQ4
NV9FTkFCTEVEKSB7Ci0tIAoyLjQwLjEKCg==

Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id AFA1877E0C9
	for <lists+linux-kernel@lfdr.de>; Wed, 16 Aug 2023 13:50:02 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244781AbjHPLtc (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Wed, 16 Aug 2023 07:49:32 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:59108 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244769AbjHPLtG (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 16 Aug 2023 07:49:06 -0400
Received: from foss.arm.com (foss.arm.com [217.140.110.172])
        by lindbergh.monkeyblade.net (Postfix) with ESMTP id 7B60B110;
        Wed, 16 Aug 2023 04:49:04 -0700 (PDT)
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.121.207.14])
        by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id 1EA4C1063;
        Wed, 16 Aug 2023 04:49:45 -0700 (PDT)
Received: from e127643.arm.com (unknown [10.57.4.137])
        by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPA id 738C43F64C;
        Wed, 16 Aug 2023 04:49:00 -0700 (PDT)
From:   James Clark <james.clark@arm.com>
To:     linux-perf-users@vger.kernel.org, irogers@google.com,
        john.g.garry@oracle.com, renyu.zj@linux.alibaba.com,
        acme@kernel.org
Cc:     James Clark <james.clark@arm.com>, Will Deacon <will@kernel.org>,
        Mike Leach <mike.leach@linaro.org>,
        Leo Yan <leo.yan@linaro.org>,
        Peter Zijlstra <peterz@infradead.org>,
        Ingo Molnar <mingo@redhat.com>,
        Mark Rutland <mark.rutland@arm.com>,
        Alexander Shishkin <alexander.shishkin@linux.intel.com>,
        Jiri Olsa <jolsa@kernel.org>,
        Namhyung Kim <namhyung@kernel.org>,
        Adrian Hunter <adrian.hunter@intel.com>,
        Kajol Jain <kjain@linux.ibm.com>,
        Haixin Yu <yuhaixin.yhx@linux.alibaba.com>,
        Nick Forrington <nick.forrington@arm.com>,
        Kan Liang <kan.liang@linux.intel.com>,
        Andrii Nakryiko <andrii@kernel.org>,
        Eduard Zingerman <eddyz87@gmail.com>,
        Sohom Datta <sohomdatta1@gmail.com>,
        Rob Herring <robh@kernel.org>, linux-kernel@vger.kernel.org,
        linux-arm-kernel@lists.infradead.org
Subject: [PATCH v6 0/6] perf vendor events arm64: Update N2 and V2 metrics and events using Arm telemetry repo
Date:   Wed, 16 Aug 2023 12:47:42 +0100
Message-Id: <20230816114841.1679234-1-james.clark@arm.com>
X-Mailer: git-send-email 2.34.1
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Spam-Status: No, score=-4.2 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_MED,
        SPF_HELO_NONE,SPF_NONE,URIBL_BLOCKED autolearn=ham autolearn_force=no
        version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

This is a completely new approach from V3 [1], although the metrics and
event descriptions are autogenerated, the topdown metrics have been
manually edited to use #no_stall_errata (now directly comparing on the
CPUID in v5). This removes the need to duplicate the whole set of JSONs
when only the topdown metrics are different between N2 and V2.

The CPU ID comparison function still needs to change so that the new
literal can compare on versions, but now no change is needed to mapfile
or the PMU event generation code because we still only support one
set of JSONs per CPU.

[1]: https://lore.kernel.org/lkml/20230711100218.1651995-1-james.clark@arm.com/

------

Changes since v5:
  * Split patch 5 into one to add the new expression builtin and one to
    update the Arm metric formulas
  * Make _get_cpuid() still return an error if reading the file fails
  * Improve the return value comment on strcmp_cpuid_str()
  * Remove the "The events json file with the highest matching version
    is used." comment because that was only true in v2
  * Drop patch 1 because it was applied (I kept patch 4 even though it
    was applied so that there is some context)

Changes since v4:
  * Replace the #no_stall_errata literal with a more generic function
    for comparing CPU IDs. This will hopefully keep configuration out
    of the code and inside the JSONs

Changes since v3:
  * Instead of duplicating all the metrics, add a new expression
    literal that can be used to share the same metrics between N2 and V2
  * Move tests to arch/arm64/tests
  * Remove changes from jevents.py and mapfile.csv

Changes since v2:
  * version -> variant in second commit message
  * Add a bit more detail about version matching in the second commit
    message
  * Update the comments in pmu-events/arch/arm64/mapfile.csv to say that
    variant and revision fields are now used
  * Increase the CC list

Changes since v1:
  * Split last change into two so it doesn't hit the mailing list size
    limit

James Clark (6):
  perf arm64: Allow version comparisons of CPU IDs
  perf test: Add a test for the new Arm CPU ID comparison behavior
  perf vendor events arm64: Update scale units and descriptions of
    common topdown metrics
  perf jevents: Add a new expression builtin strcmp_cpuid_str()
  perf vendor events arm64: Update stall_slot workaround for N2 r0p3
  perf vendor events arm64: Update N2 and V2 metrics and events using
    Arm telemetry repo

 tools/perf/arch/arm64/include/arch-tests.h    |   3 +
 tools/perf/arch/arm64/tests/Build             |   1 +
 tools/perf/arch/arm64/tests/arch-tests.c      |   4 +
 tools/perf/arch/arm64/tests/cpuid-match.c     |  38 ++
 tools/perf/arch/arm64/util/header.c           |  67 +++-
 tools/perf/arch/arm64/util/pmu.c              |  18 +-
 .../arch/arm64/arm/neoverse-n2-v2/branch.json |   8 -
 .../arch/arm64/arm/neoverse-n2-v2/bus.json    |  18 +-
 .../arch/arm64/arm/neoverse-n2-v2/cache.json  | 155 --------
 .../arm64/arm/neoverse-n2-v2/exception.json   |  45 ++-
 .../arm/neoverse-n2-v2/fp_operation.json      |  22 ++
 .../arm64/arm/neoverse-n2-v2/general.json     |  10 +
 .../arm64/arm/neoverse-n2-v2/instruction.json | 143 -------
 .../arm64/arm/neoverse-n2-v2/l1d_cache.json   |  54 +++
 .../arm64/arm/neoverse-n2-v2/l1i_cache.json   |  14 +
 .../arm64/arm/neoverse-n2-v2/l2_cache.json    |  50 +++
 .../arm64/arm/neoverse-n2-v2/l3_cache.json    |  22 ++
 .../arm64/arm/neoverse-n2-v2/ll_cache.json    |  10 +
 .../arch/arm64/arm/neoverse-n2-v2/memory.json |  39 +-
 .../arm64/arm/neoverse-n2-v2/metrics.json     | 365 ++++++++++--------
 .../arm64/arm/neoverse-n2-v2/pipeline.json    |  23 --
 .../arm64/arm/neoverse-n2-v2/retired.json     |  30 ++
 .../arch/arm64/arm/neoverse-n2-v2/spe.json    |  12 +-
 .../arm/neoverse-n2-v2/spec_operation.json    | 110 ++++++
 .../arch/arm64/arm/neoverse-n2-v2/stall.json  |  30 ++
 .../arch/arm64/arm/neoverse-n2-v2/sve.json    |  50 +++
 .../arch/arm64/arm/neoverse-n2-v2/tlb.json    |  66 ++++
 .../arch/arm64/arm/neoverse-n2-v2/trace.json  |  27 +-
 tools/perf/pmu-events/arch/arm64/sbsa.json    |  24 +-
 tools/perf/pmu-events/metric.py               |  17 +-
 tools/perf/util/expr.c                        |  18 +
 tools/perf/util/expr.h                        |   1 +
 tools/perf/util/expr.l                        |   1 +
 tools/perf/util/expr.y                        |   8 +-
 tools/perf/util/pmu.c                         |  17 +
 tools/perf/util/pmu.h                         |   1 +
 36 files changed, 923 insertions(+), 598 deletions(-)
 create mode 100644 tools/perf/arch/arm64/tests/cpuid-match.c
 delete mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/branch.json
 delete mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/cache.json
 create mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/fp_operation.json
 create mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/general.json
 delete mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/instruction.json
 create mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/l1d_cache.json
 create mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/l1i_cache.json
 create mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/l2_cache.json
 create mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/l3_cache.json
 create mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/ll_cache.json
 delete mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/pipeline.json
 create mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/retired.json
 create mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/spec_operation.json
 create mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/stall.json
 create mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/sve.json
 create mode 100644 tools/perf/pmu-events/arch/arm64/arm/neoverse-n2-v2/tlb.json

-- 
2.34.1

